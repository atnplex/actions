name: "Branch Protection Enforcer"
description: "Enforces strict branch protection rules on main/master"

inputs:
  repository:
    description: "Repository to enforce rules on (owner/repo)"
    required: true
    type: string
  admin-token:
    description: "Personal Access Token with admin:repo scope"
    required: true
    type: string

runs:
  using: "composite"
  steps:
    - name: Enforce Protection
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.admin-token }}
        REPO: ${{ inputs.repository }}
      run: |
        echo "Applying protection to $REPO..."
        
        # Get default branch
        DEFAULT_BRANCH=$(gh repo view "$REPO" --json defaultBranchRef --jq .defaultBranchRef.name)
        echo "Default branch: $DEFAULT_BRANCH"

        # Apply strict rules
        gh api --method PUT "repos/$REPO/branches/$DEFAULT_BRANCH/protection" \
          -f required_status_checks.strict=true \
          -f required_status_checks.contexts[]="Lint Self" \
          -f required_status_checks.contexts[]="CodeQL" \
          -f enforce_admins=true \
          -f required_pull_request_reviews.dismiss_stale_reviews=true \
          -f required_pull_request_reviews.require_code_owner_reviews=false \
          -f required_pull_request_reviews.required_approving_review_count=1 \
          -f restrictions=null \
          -f allow_force_pushes=false \
          -f allow_deletions=false
          
        echo "Protection applied."
